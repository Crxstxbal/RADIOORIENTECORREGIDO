{% extends 'dashboard/base.html' %}

{% block page_title %}Gestión de Radio{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-broadcast-tower text-primary me-2"></i>
        Gestión de Radio
    </h2>
    <div>
        <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addProgramModal">
            <i class="fas fa-plus me-2"></i>
            Nuevo Programa
        </button>
        <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#stationConfigModal">
            <i class="fas fa-cog me-2"></i>
            Configurar Estación
        </button>
    </div>
</div>

<!-- Estado de la estación -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="fas fa-radio text-danger me-2"></i>
                    Estado de la Estación
                </h5>
            </div>
            <div class="card-body" id="station-status">
                {% if station %}
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-2">
                            <h6 id="station-name" class="mb-0 me-3">{{ station.nombre }}</h6>
                            <form method="post" action="{% url 'toggle_station_status' %}" class="d-inline" id="toggle-status-form">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm {% if station.activo %}btn-outline-danger{% else %}btn-outline-success{% endif %}">
                                    <i class="fas {% if station.activo %}fa-pause{% else %}fa-play{% endif %} me-1"></i>
                                    {% if station.activo %}Pausar Transmisión{% else %}Iniciar Transmisión{% endif %}
                                </button>
                            </form>
                        </div>
                        <p class="text-muted mb-1" id="station-desc">{{ station.descripcion|default:"Sin descripción" }}</p>
                        <p class="mb-0">
                            <strong>Stream URL:</strong> 
                            <code id="station-url">{{ station.stream_url|default:"No configurado" }}</code>
                        </p>
                    </div>
                    <div class="col-md-6 text-end">
                        <div id="station-live-status">
                            {% if station.activo %}
                                <span class="badge bg-success fs-6 me-3">
                                    <i class="fas fa-circle-check me-1"></i>
                                    ONLINE
                                </span>
                            {% else %}
                                <span class="badge bg-danger fs-6 me-3">
                                    <i class="fas fa-power-off me-1"></i>
                                    OFFLINE
                                </span>
                            {% endif %}
                        </div>
                        <div class="text-end mt-2">
                            <small class="text-muted" id="station-current-song">
                                Canción actual: {{ station.cancion_actual|default:"Sin información" }}
                            </small>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-radio fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No hay configuración de estación</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#stationConfigModal">
                        Configurar Estación
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Estadísticas de la radio -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0">Estadísticas</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-3">
                    <span>Programas Activos</span>
                    <strong>{{ programs|length }}</strong>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span>Artículos</span>
                    <strong>{{ total_articulos_count }}</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Estado</span>
                    {% if station.activo %}
                        <span class="text-success"><strong>Online</strong></span>
                    {% else %}
                        <span class="text-danger"><strong>Offline</strong></span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Programación -->
<div class="row">
    <!-- Tabla de Programas -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-alt text-info me-2"></i>
                    Programación
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Programa</th>
                                <th>Horario</th>
                                <th>Días</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for program in programs %}
                            <tr>
                                <td>
                                    <div>
                                        <strong>{{ program.nombre }}</strong>
                                        <br><small class="text-muted">{{ program.descripcion|truncatechars:50 }}</small>
                                    </div>
                                </td>
                                <td>
                                    {{ program.hora_inicio|time:"H:i" }} - {{ program.hora_fin|time:"H:i" }}
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ program.dias_semana|default:"Todos los días" }}</span>
                                </td>
                                <td>
                                    {% if program.activo %}
                                        <span class="badge bg-success">Activo</span>
                                    {% else %}
                                        <span class="badge bg-danger">Inactivo</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                data-bs-toggle="modal" data-bs-target="#editProgramModal"
                                                data-program-id="{{ program.id }}"
                                                data-program-nombre="{{ program.nombre }}"
                                                data-program-descripcion="{{ program.descripcion }}"
                                                data-program-hora-inicio="{{ program.hora_inicio|time:'H:i' }}"
                                                data-program-hora-fin="{{ program.hora_fin|time:'H:i' }}"
                                                data-program-dias="{{ program.dias_semana }}"
                                                data-program-activo="{{ program.activo }}"
                                                title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger delete-program"
                                                data-url="{% url 'delete_program' program.id %}"
                                                data-name="{{ program.nombre|escapejs }}"
                                                title="Eliminar">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-4">
                                    <i class="fas fa-calendar fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">No hay programas configurados</p>
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProgramModal">
                                        Crear Primer Programa
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Artículos Recientes -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-newspaper text-warning me-2"></i>
                    Artículos Recientes
                </h5>
                <span class="badge bg-primary">
                    <i class="fas fa-file-alt me-1"></i>
                    {{ total_articulos }} total
                </span>
            </div>
            <div class="card-body">
                {% for articulo in articulos_recientes %}
                <div class="d-flex mb-3">
                    {% if articulo.imagen_thumbnail %}
                    <img src="{{ articulo.imagen_thumbnail.url }}" class="rounded me-3" alt="{{ articulo.titulo }}" style="width: 60px; height: 60px; object-fit: cover;">
                    {% elif articulo.imagen_portada %}
                    <img src="{{ articulo.imagen_portada.url }}" class="rounded me-3" alt="{{ articulo.titulo }}" style="width: 60px; height: 60px; object-fit: cover;">
                    {% elif articulo.imagen_url %}
                    <img src="{{ articulo.imagen_url }}" class="rounded me-3" alt="{{ articulo.titulo }}" style="width: 60px; height: 60px; object-fit: cover;">
                    {% else %}
                    <div class="bg-light d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px;">
                        <i class="fas fa-image text-muted"></i>
                    </div>
                    {% endif %}
                    <div class="flex-grow-1">
                        <h6 class="mb-0" style="font-size: 0.9rem;">
                            <a href="/api/articulos/articulos/{{ articulo.slug }}/" class="text-dark text-decoration-none">{{ articulo.titulo|truncatechars:50 }}</a>
                        </h6>
                        {% if articulo.categoria %}
                        <span class="badge bg-light text-dark border mb-1" style="font-size: 0.7rem; font-weight: normal;">
                            {{ articulo.categoria.nombre }}
                        </span>
                        {% endif %}
                        <div class="small text-muted">
                            {{ articulo.fecha_publicacion|date:"d M Y"|default:articulo.fecha_creacion|date:"d M Y" }}
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-4">
                    <i class="fas fa-newspaper fa-2x text-muted mb-3"></i>
                    <p class="text-muted">No hay artículos recientes</p>
                </div>
                {% endfor %}
        </div>
    </div>
</div>

<!-- Modal para agregar programa -->
<div class="modal fade" id="addProgramModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nuevo Programa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'create_program' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nombre" class="form-label">Nombre del Programa</label>
                        <input type="text" class="form-control" name="nombre" required>
                    </div>
                    <div class="mb-3">
                        <label for="descripcion" class="form-label">Descripción</label>
                        <textarea class="form-control" name="descripcion" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Días de Emisión *</label>
                        <div class="row g-2">
                            <div class="col-md-3 col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="dias[]" value="1" id="dia-lunes-add">
                                    <label class="form-check-label" for="dia-lunes-add">Lunes</label>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="dias[]" value="2" id="dia-martes-add">
                                    <label class="form-check-label" for="dia-martes-add">Martes</label>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="dias[]" value="3" id="dia-miercoles-add">
                                    <label class="form-check-label" for="dia-miercoles-add">Miércoles</label>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="dias[]" value="4" id="dia-jueves-add">
                                    <label class="form-check-label" for="dia-jueves-add">Jueves</label>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="dias[]" value="5" id="dia-viernes-add">
                                    <label class="form-check-label" for="dia-viernes-add">Viernes</label>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="dias[]" value="6" id="dia-sabado-add">
                                    <label class="form-check-label" for="dia-sabado-add">Sábado</label>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="dias[]" value="0" id="dia-domingo-add">
                                    <label class="form-check-label" for="dia-domingo-add">Domingo</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="hora_inicio" class="form-label">Hora de Inicio *</label>
                                <input type="time" class="form-control" name="hora_inicio" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="hora_fin" class="form-label">Hora de Fin *</label>
                                <input type="time" class="form-control" name="hora_fin" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="activo" id="activo" checked>
                        <label class="form-check-label" for="activo">Programa activo</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear Programa</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para configurar estación -->
<div class="modal fade" id="stationConfigModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'update_station' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Configuración de Estación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nombre de la Estación</label>
                        <input type="text" class="form-control" name="nombre" value="{{ station.nombre|default:'Radio Oriente FM' }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-control" name="descripcion" rows="3">{{ station.descripcion|default:'' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">URL del Stream</label>
                        <input type="url" class="form-control" name="stream_url" value="{{ station.stream_url|default:'' }}" placeholder="https://stream.example.com/radio">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Canción Actual</label>
                        <input type="text" class="form-control" name="cancion_actual" value="{{ station.cancion_actual|default:'' }}" placeholder="Artista - Canción">
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="activo" id="stationActive" {% if station.activo %}checked{% endif %}>
                        <label class="form-check-label" for="stationActive">Estación en vivo</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Configuración</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para editar programa -->
<div class="modal fade" id="editProgramModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Programa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="editProgramForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit-nombre" class="form-label">Nombre del Programa</label>
                        <input type="text" class="form-control" name="nombre" id="edit-nombre" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-descripcion" class="form-label">Descripción</label>
                        <textarea class="form-control" name="descripcion" id="edit-descripcion" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Días de Emisión *</label>
                        <div class="row g-2">
                            <div class="col-md-3 col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="dias[]" value="1" id="dia-lunes-edit">
                                    <label class="form-check-label" for="dia-lunes-edit">Lunes</label>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="dias[]" value="2" id="dia-martes-edit">
                                    <label class="form-check-label" for="dia-martes-edit">Martes</label>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="dias[]" value="3" id="dia-miercoles-edit">
                                    <label class="form-check-label" for="dia-miercoles-edit">Miércoles</label>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="dias[]" value="4" id="dia-jueves-edit">
                                    <label class="form-check-label" for="dia-jueves-edit">Jueves</label>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="dias[]" value="5" id="dia-viernes-edit">
                                    <label class="form-check-label" for="dia-viernes-edit">Viernes</label>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="dias[]" value="6" id="dia-sabado-edit">
                                    <label class="form-check-label" for="dia-sabado-edit">Sábado</label>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="dias[]" value="0" id="dia-domingo-edit">
                                    <label class="form-check-label" for="dia-domingo-edit">Domingo</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit-hora-inicio" class="form-label">Hora de Inicio *</label>
                                <input type="time" class="form-control" name="hora_inicio" id="edit-hora-inicio" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit-hora-fin" class="form-label">Hora de Fin *</label>
                                <input type="time" class="form-control" name="hora_fin" id="edit-hora-fin" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="activo" id="edit-activo">
                        <label class="form-check-label" for="edit-activo">
                            Programa activo
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Actualizar Programa</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function deleteItem(url, name) {
    if (confirm('¿Estás seguro de que deseas eliminar el programa: ' + name + '?')) {
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'csrfmiddlewaretoken={{ csrf_token }}'
        }).then(function(response) {
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Error al eliminar el programa');
            }
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Manejar click en botones de editar programa
    document.querySelectorAll('[data-bs-target="#editProgramModal"]').forEach(function(button) {
        button.addEventListener('click', function() {
            var programId = this.getAttribute('data-program-id');
            var nombre = this.getAttribute('data-program-nombre');
            var descripcion = this.getAttribute('data-program-descripcion');
            var horaInicio = this.getAttribute('data-program-hora-inicio');
            var horaFin = this.getAttribute('data-program-hora-fin');
            var dias = this.getAttribute('data-program-dias');
            var activo = this.getAttribute('data-program-activo') === 'True';
            
            // Llenar el formulario
            document.getElementById('edit-nombre').value = nombre || '';
            document.getElementById('edit-descripcion').value = descripcion || '';
            document.getElementById('edit-hora-inicio').value = horaInicio || '';
            document.getElementById('edit-hora-fin').value = horaFin || '';
            document.getElementById('edit-dias').value = dias || '';
            document.getElementById('edit-activo').checked = activo;
            
            // Actualizar la acción del formulario
            
    // Manejar clic en botones de eliminar
    document.querySelectorAll('.delete-program').forEach(function(button) {
        button.addEventListener('click', function() {
            var url = this.getAttribute('data-url');
            var name = this.getAttribute('data-name');
            deleteItem(url, name);
        });
    });
    
    // Actualizar la acción del formulario
            document.getElementById('editProgramForm').action = `/dashboard/radio/edit-program/${programId}/`;
        });
    });
});
</script>
{% endblock %}
