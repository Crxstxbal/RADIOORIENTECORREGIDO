{% extends 'dashboard/base.html' %}
{% block page_title %} Bandas Emergentes {% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2><i class="fas fa-guitar text-danger me-2"></i> Bandas Emergentes</h2>
  <div class="d-flex gap-2 align-items-center">
    <span class="badge bg-primary">Total: {{ total_bandas }}</span>
    {% for estado, count in stats_estados.items %}
      <span class="badge bg-secondary">{{ estado }}: {{ count }}</span>
    {% endfor %}
    <a href="{% url 'crear_banda_emergente' %}" class="btn btn-success btn-sm ms-2">
      <i class="fas fa-plus-circle me-1"></i> Nueva Banda
    </a>
  </div>
</div>

<!-- Sección para gestionar géneros musicales -->
<div class="card mb-4">
  <div class="card-header bg-dark text-white">
    <i class="fas fa-music me-2"></i>Gestión de Géneros Musicales
  </div>
  <div class="card-body">
    <form method="post" action="{% url 'agregar_genero' %}" class="row g-3">
      {% csrf_token %}
      <div class="col-md-5">
        <label for="nuevoGenero" class="form-label">Nombre del Género</label>
        <input type="text" class="form-control" id="nuevoGenero" name="nombre" placeholder="Ej: Rock, Pop, Jazz..." required>
      </div>
      <div class="col-md-5">
        <label for="descripcionGenero" class="form-label">Descripción</label>
        <input type="text" class="form-control" id="descripcionGenero" name="descripcion" placeholder="Breve descripción del género...">
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">
          <i class="fas fa-plus-circle me-1"></i> Agregar
        </button>
      </div>
    </form>
    
    <div class="mt-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0">Ver todo para ver los géneros musicales de las bandas y artistas emergentes</h6>
        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#listaGeneros" aria-expanded="false" aria-controls="listaGeneros">
          <i class="fas fa-list me-1"></i> Ver todos
        </button>
      </div>
      
      <div class="collapse" id="listaGeneros">
        <div class="card card-body mb-3">
          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <thead>
                <tr>
                  <th>Género</th>
                  <th>Descripción</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for genero in generos %}
                <tr>
                  <td><strong>{{ genero.nombre }}</strong></td>
                  <td>{{ genero.descripcion|default:"Sin descripción" }}</td>
                  <td>
                    <form method="post" action="{% url 'eliminar_genero' genero.id %}" class="d-inline" onsubmit="return confirm('¿Estás seguro de eliminar este género? Las bandas existentes mantendrán este género.');">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-outline-danger">
                        <i class="fas fa-trash-alt"></i>
                      </button>
                    </form>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="3" class="text-center text-muted">No hay géneros registrados.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
    </div>
  </div>
</div>

<!-- Tabla de bandas emergentes -->
<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Nombre</th>
            <th>Género</th>
            <th>Ciudad</th>
            <th>Contacto</th>
            <th>Estado</th>
            <th>Fecha Envío</th>
            <th>Revisado Por</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for banda in bandas %}
          <tr>
            <td>
              <strong>{{ banda.nombre_banda }}</strong>
              {% if banda.integrantes.exists %}
                <br><small class="text-muted">
                  <i class="fas fa-users me-1"></i>
                  {% for integrante in banda.integrantes.all %}
                    {{ integrante.integrante.nombre }}{% if not forloop.last %}, {% endif %}
                  {% endfor %}
                </small>
              {% endif %}
            </td>
            <td>{{ banda.genero.nombre }}</td>
            <td>
              {% if banda.comuna %}
                {{ banda.comuna.nombre }}, {{ banda.comuna.ciudad.nombre }}
              {% else %}
                <span class="text-muted">No especificada</span>
              {% endif %}
            </td>
            <td>
              <div><i class="fas fa-envelope me-1 text-muted"></i> {{ banda.email_contacto }}</div>
              {% if banda.telefono_contacto %}
                <div><i class="fas fa-phone me-1 text-muted"></i> {{ banda.telefono_contacto }}</div>
              {% endif %}
            </td>
            <td>
              <span class="badge 
                {% if banda.estado.nombre == 'Recibida' %} bg-warning
                {% elif banda.estado.nombre == 'En Revisión' %} bg-info
                {% elif banda.estado.nombre == 'Aprobada' %} bg-success
                {% elif banda.estado.nombre == 'Rechazada' %} bg-danger
                {% endif %}">
                {{ banda.estado.nombre }}
              </span>
            </td>
            <td>{{ banda.fecha_envio|date:"d/m/Y H:i" }}</td>
            <td>
              {% if banda.revisado_por %}
                <small>{{ banda.revisado_por.get_full_name|default:banda.revisado_por.username }}</small>
                <br><small class="text-muted">{{ banda.fecha_revision|date:"d/m/Y H:i" }}</small>
              {% else %}
                <span class="text-muted">Pendiente</span>
              {% endif %}
            </td>
            <td>
              <div class="d-flex flex-wrap gap-1">
                <!-- Botones de estado -->
                <div class="btn-group" role="group">
                  <a href="{% url 'cambiar_estado_banda' banda.id 'revision' %}" class="btn btn-sm btn-info" title="En Revisión">
                    <i class="fas fa-eye"></i>
                  </a>
                  <a href="{% url 'cambiar_estado_banda' banda.id 'aprobado' %}" class="btn btn-sm btn-success" title="Aprobar">
                    <i class="fas fa-check"></i>
                  </a>
                  <a href="{% url 'cambiar_estado_banda' banda.id 'rechazado' %}" class="btn btn-sm btn-danger" title="Rechazar">
                    <i class="fas fa-times"></i>
                  </a>
                  <a href="{% url 'cambiar_estado_banda' banda.id 'pendiente' %}" class="btn btn-sm btn-secondary" title="Marcar como Pendiente">
                    <i class="fas fa-clock"></i>
                  </a>
                </div>

                <!-- Botón de detalle -->
                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#bandaModal{{ banda.id }}" title="Ver detalles">
                  <i class="fas fa-search-plus"></i>
                </button>

                <!-- Eliminar -->
                <form method="POST" action="{% url 'eliminar_banda_emergente' banda.id %}" class="d-inline" onsubmit="return confirm('¿Estás seguro de eliminar esta banda?');">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-danger" title="Eliminar">
                    <i class="fas fa-trash"></i>
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center text-muted py-4">
              <i class="fas fa-music me-2"></i> No hay postulaciones aún.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ======================
     MODALES FUERA DE LA TABLA
======================= -->
{% for banda in bandas %}
<div class="modal fade" id="bandaModal{{ banda.id }}" tabindex="-1" aria-labelledby="bandaModalLabel{{ banda.id }}" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title" id="bandaModalLabel{{ banda.id }}">
          <i class="fas fa-music me-2"></i> {{ banda.nombre_banda }}
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <p><strong>Integrantes:</strong></p>
            {% if banda.integrantes.exists %}
              <ul class="list-unstyled">
                {% for integrante in banda.integrantes.all %}
                  <li><i class="fas fa-user me-2"></i>{{ integrante.integrante.nombre }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted">No especificados</p>
            {% endif %}
            
            <p><strong>Género:</strong> {{ banda.genero.nombre }}</p>
            <p><strong>Ubicación:</strong> 
              {% if banda.comuna %}
                {{ banda.comuna.nombre }}, {{ banda.comuna.ciudad.nombre }}, {{ banda.comuna.ciudad.pais.nombre }}
              {% else %}
                <span class="text-muted">No especificada</span>
              {% endif %}
            </p>
          </div>
          <div class="col-md-6">
            <p><strong>Contacto:</strong></p>
            <p><i class="fas fa-envelope me-1 text-muted"></i> {{ banda.email_contacto }}</p>
            {% if banda.telefono_contacto %}
              <p><i class="fas fa-phone me-1 text-muted"></i> {{ banda.telefono_contacto }}</p>
            {% endif %}
            
            <p><strong>Estado:</strong> 
              <span class="badge 
                {% if banda.estado.nombre == 'Recibida' %} bg-warning
                {% elif banda.estado.nombre == 'En Revisión' %} bg-info
                {% elif banda.estado.nombre == 'Aprobada' %} bg-success
                {% elif banda.estado.nombre == 'Rechazada' %} bg-danger
                {% endif %}">
                {{ banda.estado.nombre }}
              </span>
            </p>
          </div>
        </div>
        
        <hr>
        <p><strong>Mensaje:</strong></p>
        <div class="bg-light p-3 rounded">{{ banda.mensaje }}</div>
        
        {% if banda.links.exists %}
          <hr>
          <p><strong>Enlaces:</strong></p>
          <div class="d-flex flex-wrap gap-2">
            {% for link in banda.links.all %}
              <a href="{{ link.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-external-link-alt me-1"></i>{{ link.tipo|title }}
              </a>
            {% endfor %}
          </div>
        {% endif %}
        
        {% if banda.documento_presentacion %}
          <hr>
          <p><strong>Documento de Presentación:</strong></p>
          <a href="{{ banda.documento_presentacion }}" target="_blank" class="btn btn-sm btn-outline-primary">
            <i class="fas fa-download"></i> Descargar
          </a>
        {% endif %}
        
        <hr>
        <div class="row">
          <div class="col-md-6">
            <p><strong>Fecha de envío:</strong> {{ banda.fecha_envio|date:"d/m/Y H:i" }}</p>
          </div>
          <div class="col-md-6">
            {% if banda.fecha_revision %}
              <p><strong>Fecha de revisión:</strong> {{ banda.fecha_revision|date:"d/m/Y H:i" }}</p>
              <p><strong>Revisado por:</strong> {{ banda.revisado_por.get_full_name|default:banda.revisado_por.username }}</p>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <a href="{% url 'cambiar_estado_banda' banda.id 'revision' %}" class="btn btn-info">
          <i class="fas fa-eye"></i> En Revisión
        </a>
        <a href="{% url 'cambiar_estado_banda' banda.id 'aprobado' %}" class="btn btn-success">
          <i class="fas fa-check"></i> Aprobar
        </a>
        <a href="{% url 'cambiar_estado_banda' banda.id 'rechazado' %}" class="btn btn-danger">
          <i class="fas fa-times"></i> Rechazar
        </a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
{% endfor %}
{% endblock %}
