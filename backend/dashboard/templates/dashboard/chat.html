{% extends 'dashboard/base.html' %}

{% block page_title %}Moderación del Chat{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-comments text-primary me-2"></i>
        Moderación del Chat
    </h2>
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-primary active">Todos</button>
        <button type="button" class="btn btn-outline-warning">Reportados</button>
        <button type="button" class="btn btn-outline-danger">Bloqueados</button>
    </div>
</div>

<!-- Estadísticas del chat -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-comments fa-2x text-primary mb-2"></i>
                <h5>{{ messages_today }}</h5>
                <small class="text-muted">Mensajes Hoy</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-users fa-2x text-success mb-2"></i>
                <h5>{{ active_users_today }}</h5>
                <small class="text-muted">Usuarios Activos Hoy</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-list fa-2x text-info mb-2"></i>
                <h5>{{ messages|length }}</h5>
                <small class="text-muted">Mensajes Recientes</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-trash fa-2x text-danger mb-2"></i>
                <h5 id="deletedMessagesCount">0</h5>
                <small class="text-muted">Mensajes Eliminados Hoy</small>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Mensajes del chat -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-white">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="mb-0">Mensajes Recientes</h5>
                    </div>
                    <div class="col-auto">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Buscar mensajes..." id="searchMessages">
                            <button class="btn btn-outline-secondary" type="button">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                {% for message in messages %}
                <div class="d-flex mb-3 pb-3 border-bottom message-item" id="message-{{ message.id }}">
                    <div class="flex-shrink-0">
                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                            <i class="fas fa-user text-white"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">{{ message.usuario_nombre|default:"Usuario anónimo" }}</h6>
                                <small class="text-muted">{{ message.sala|default:"radio-oriente" }} • hace {{ message.fecha_envio|timesince }}</small>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <button class="dropdown-item text-danger delete-message-btn" data-message-id="{{ message.id }}">
                                            <i class="fas fa-trash me-2"></i>Eliminar
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <p class="mb-0 mt-2">{{ message.contenido }}</p>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-4">
                    <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No hay mensajes en el chat</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Panel de moderación -->
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="fas fa-shield-alt text-success me-2"></i>
                    Herramientas de Moderación
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-warning" onclick="clearAllMessages()">
                        <i class="fas fa-broom me-2"></i>
                        Limpiar Chat
                    </button>
                    <button class="btn btn-outline-info">
                        <i class="fas fa-robot me-2"></i>
                        Filtros Automáticos
                    </button>
                    <button class="btn btn-outline-success">
                        <i class="fas fa-download me-2"></i>
                        Exportar Logs
                    </button>
                </div>
            </div>
        </div>

        <!-- Usuarios más activos -->
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="fas fa-star text-warning me-2"></i>
                    Usuarios Más Activos
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center">
                        <div class="bg-success rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                            <i class="fas fa-user text-white small"></i>
                        </div>
                        <div>
                            <strong>juan_radio</strong>
                            <br><small class="text-muted">47 mensajes</small>
                        </div>
                    </div>
                    <span class="badge bg-success">Activo</span>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center">
                        <div class="bg-info rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                            <i class="fas fa-user text-white small"></i>
                        </div>
                        <div>
                            <strong>maria_music</strong>
                            <br><small class="text-muted">32 mensajes</small>
                        </div>
                    </div>
                    <span class="badge bg-primary">Online</span>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center">
                        <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                            <i class="fas fa-user text-white small"></i>
                        </div>
                        <div>
                            <strong>carlos_fm</strong>
                            <br><small class="text-muted">28 mensajes</small>
                        </div>
                    </div>
                    <span class="badge bg-secondary">Offline</span>
                </div>
            </div>
        </div>

        <!-- Palabras filtradas -->
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="fas fa-filter text-danger me-2"></i>
                    Filtros de Contenido
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Palabras Prohibidas</label>
                    <textarea class="form-control" rows="3" placeholder="Ingresa palabras separadas por comas"></textarea>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="autoFilter" checked>
                    <label class="form-check-label" for="autoFilter">
                        Filtro automático activado
                    </label>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="linkFilter">
                    <label class="form-check-label" for="linkFilter">
                        Bloquear enlaces
                    </label>
                </div>
                <button class="btn btn-primary btn-sm w-100">
                    Actualizar Filtros
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Búsqueda de mensajes
document.getElementById('searchMessages').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const messages = document.querySelectorAll('.message-item');
    
    messages.forEach(message => {
        const text = message.textContent.toLowerCase();
        message.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

// Auto-actualizar mensajes cada 2 segundos sin recargar la página
console.log('Iniciando sistema de actualización automática de mensajes...');
let isUpdating = false;
let deletedMessagesToday = 0;

async function updateMessages() {
    if (isUpdating) return;
    isUpdating = true;

    try {
        const response = await fetch('/api/chat/messages/radio-oriente/', {
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });

        console.log('Respuesta de actualización:', response.status);

        if (response.ok) {
            const data = await response.json();
            const messages = Array.isArray(data) ? data : (data.results || []);
            console.log('Mensajes recibidos:', messages.length);

            // Actualizar el contenedor de mensajes
            updateMessagesContainer(messages);

            // Actualizar estadísticas
            updateStatistics(messages);
        } else {
            console.error('Error en respuesta:', response.status, response.statusText);
        }
    } catch (error) {
        console.error('Error updating messages:', error);
    } finally {
        isUpdating = false;
    }
}

function updateMessagesContainer(messages) {
    const container = document.querySelector('.card-body[style*="max-height"]');
    if (!container) return;

    // Si no hay mensajes
    if (messages.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                <p class="text-muted">No hay mensajes en el chat</p>
            </div>
        `;
        return;
    }

    // Construir HTML de mensajes
    let messagesHTML = '';
    messages.slice(0, 50).forEach(message => {
        const timeAgo = getTimeAgo(new Date(message.fecha_envio));
        messagesHTML += `
            <div class="d-flex mb-3 pb-3 border-bottom message-item" id="message-${message.id}">
                <div class="flex-shrink-0">
                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                        <i class="fas fa-user text-white"></i>
                    </div>
                </div>
                <div class="flex-grow-1 ms-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${message.usuario_nombre || 'Usuario anónimo'}</h6>
                            <small class="text-muted">${message.sala || 'radio-oriente'} • ${timeAgo}</small>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <button class="dropdown-item text-warning toggle-block-btn"
                                            data-user-id="${message.id_usuario}"
                                            data-user-name="${message.usuario_nombre}"
                                            data-blocked="${message.usuario_bloqueado || false}">
                                        <i class="fas fa-${message.usuario_bloqueado ? 'unlock' : 'ban'} me-2"></i>${message.usuario_bloqueado ? 'Desbloquear' : 'Bloquear'}
                                    </button>
                                </li>
                                <li>
                                    <button class="dropdown-item text-danger delete-message-btn" data-message-id="${message.id}">
                                        <i class="fas fa-trash me-2"></i>Eliminar
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <p class="mb-0 mt-2">${escapeHtml(message.contenido)}</p>
                </div>
            </div>
        `;
    });

    container.innerHTML = messagesHTML;
}

function updateStatistics(messages) {
    // Actualizar mensajes recientes
    const recentMessagesCard = document.querySelector('.col-md-3:nth-child(3) .card-body h5');
    if (recentMessagesCard) {
        recentMessagesCard.textContent = messages.length;
    }

    // Calcular mensajes de hoy
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const messagesToday = messages.filter(msg => {
        const msgDate = new Date(msg.fecha_envio);
        return msgDate >= today;
    });

    const todayCard = document.querySelector('.col-md-3:nth-child(1) .card-body h5');
    if (todayCard) {
        todayCard.textContent = messagesToday.length;
    }

    // Calcular usuarios únicos activos hoy
    const uniqueUsers = new Set(messagesToday.map(msg => msg.id_usuario));
    const activeUsersCard = document.querySelector('.col-md-3:nth-child(2) .card-body h5');
    if (activeUsersCard) {
        activeUsersCard.textContent = uniqueUsers.size;
    }
}

function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);

    if (seconds < 60) return 'hace unos segundos';
    if (seconds < 3600) {
        const minutes = Math.floor(seconds / 60);
        return `hace ${minutes} minuto${minutes !== 1 ? 's' : ''}`;
    }
    if (seconds < 86400) {
        const hours = Math.floor(seconds / 3600);
        return `hace ${hours} hora${hours !== 1 ? 's' : ''}`;
    }
    const days = Math.floor(seconds / 86400);
    return `hace ${days} día${days !== 1 ? 's' : ''}`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Actualizar inmediatamente y luego cada 2 segundos
updateMessages();
setInterval(updateMessages, 2000);

// Función para eliminar mensajes
document.addEventListener('click', function(e) {
    if (e.target.closest('.delete-message-btn')) {
        const button = e.target.closest('.delete-message-btn');
        const messageId = button.getAttribute('data-message-id');

        if (confirm('¿Estás seguro de que quieres eliminar este mensaje?')) {
            console.log('Intentando eliminar mensaje:', messageId);
            fetch(`/api/chat/messages/${messageId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                console.log('Respuesta del servidor:', response.status);
                if (response.ok) {
                    deletedMessagesToday++;
                    document.getElementById('deletedMessagesCount').textContent = deletedMessagesToday;
                    showNotification('Mensaje eliminado correctamente', 'success');
                    // Recargar mensajes inmediatamente
                    updateMessages();
                } else {
                    return response.json().then(data => {
                        console.error('Error response:', data);
                        showNotification('Error: ' + (data.detail || response.statusText || 'No autorizado'), 'danger');
                    }).catch(() => {
                        showNotification(`Error ${response.status}: No autorizado`, 'danger');
                    });
                }
            })
            .catch(error => {
                console.error('Error en fetch:', error);
                showNotification('Error al eliminar el mensaje: ' + error.message, 'danger');
            });
        }
    }

    // Función para bloquear/desbloquear usuario
    if (e.target.closest('.toggle-block-btn')) {
        const button = e.target.closest('.toggle-block-btn');
        const userId = button.getAttribute('data-user-id');
        const userName = button.getAttribute('data-user-name');
        const isBlocked = button.getAttribute('data-blocked') === 'true';

        const action = isBlocked ? 'desbloquear' : 'bloquear';
        if (confirm(`¿Estás seguro de que quieres ${action} a ${userName}?`)) {
            console.log(`Intentando ${action} usuario:`, userId);
            fetch(`/api/chat/users/${userId}/toggle-block/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    // Recargar mensajes inmediatamente
                    updateMessages();
                } else {
                    showNotification('Error: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error en fetch:', error);
                showNotification('Error al cambiar estado del usuario: ' + error.message, 'danger');
            });
        }
    }
});

// Función para limpiar todos los mensajes
function clearAllMessages() {
    if (confirm('¿Estás seguro de que quieres eliminar TODOS los mensajes del chat? Esta acción no se puede deshacer.')) {
        fetch('/api/chat/messages/clear/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ sala: 'radio-oriente' }),
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                deletedMessagesToday += data.deleted_count || 0;
                document.getElementById('deletedMessagesCount').textContent = deletedMessagesToday;
                showNotification(data.message, 'success');
                // Recargar mensajes inmediatamente
                updateMessages();
            } else {
                showNotification('Error: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error en fetch:', error);
            showNotification('Error al limpiar el chat: ' + error.message, 'danger');
        });
    }
}

// Función para obtener cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Función para mostrar notificaciones
function showNotification(message, type = 'primary') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0 position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-info-circle me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    document.body.appendChild(toast);

    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();

    toast.addEventListener('hidden.bs.toast', function() {
        toast.remove();
    });
}
</script>
{% endblock %}
